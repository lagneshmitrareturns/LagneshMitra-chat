<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LagneshMitra – Decision Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ================= TOP BAR ================= -->
<div class="topbar">
  <div class="brand">
    LagneshMitra
    <span>Decision Intelligence</span>
  </div>

  <!-- THREE DOTS -->
  <div class="menu" id="menuBtn"
       style="
         position:absolute;
         right:18px;
         top:14px;
         font-size:38px;
         padding:8px 12px;
         cursor:pointer;
         user-select:none;
       ">⋮</div>

  <div class="dropdown glass" id="menuBox" style="display:none">
    <p><strong>Core Thinking</strong></p>
    <p>Interpretation before prediction</p>
    <p>Decisions before remedies</p>
    <p>Structure before emotion</p>
    <hr style="margin:12px 0;opacity:.3">
    <a href="admin-posts.html" target="_blank"
       style="color:#ff5da2;font-weight:600;text-decoration:none">
      Admin Panel
    </a>
  </div>
</div>

<!-- ================= HERO ================= -->
<div class="hero">
  <div class="post-card glass" id="postCard">
    <h3>Hall of Fame</h3>

    <div class="meta" id="postMeta"></div>
    <div class="post-preview" id="postPreview"></div>
    <div class="post-full" id="postFull"></div>

    <!-- ✅ EXPLICIT TOGGLE BUTTON -->
    <button id="toggleBtn"
      style="
        margin-top:18px;
        padding:10px 18px;
        background:#ff5da2;
        border:none;
        border-radius:10px;
        color:#1b0f2e;
        font-weight:600;
        cursor:pointer;
      ">
      Expand
    </button>
  </div>
</div>

<!-- ================= ZENO ================= -->
<div id="zeno-eye">
  <div class="ring"></div>
  <div class="pupil"></div>
  <div class="lid"></div>
</div>

<div id="zeno-cloud" class="glass" style="display:none"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, updateDoc,
  collection, getDocs, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey:"AIzaSyCX8yGRJc5AcxSEaaC6AzNLZzxtOCz83Sk",
  authDomain:"lagneshmitra-e57b8.firebaseapp.com",
  projectId:"lagneshmitra-e57b8"
});
const db = getFirestore(app);

/* ================= MENU ================= */
const menuBtn = document.getElementById("menuBtn");
const menuBox = document.getElementById("menuBox");

menuBtn.onclick = (e) => {
  e.stopPropagation();
  menuBox.style.display =
    menuBox.style.display === "block" ? "none" : "block";
};

document.body.addEventListener("click", () => {
  menuBox.style.display = "none";
});

/* ================= HALL OF FAME ================= */
let expanded = false;
let viewCounted = false;
let currentPost = null;
let isToggling = false;

const postCard = document.getElementById("postCard");
const toggleBtn = document.getElementById("toggleBtn");

async function loadLatestPost(){
  const snap = await getDocs(collection(db,"posts"));
  let latest = null;

  snap.forEach(d=>{
    const data = d.data();
    if(!latest || (data.updatedAt?.seconds||0) >
       (latest.updatedAt?.seconds||0)){
      latest = { id:d.id, ...data };
    }
  });

  if(!latest) return;
  currentPost = latest;

  postPreview.innerText =
    latest.content.slice(0,260) +
    (latest.content.length>260?"...":"");

  postFull.innerText = latest.content;

  const hrs = Math.floor(
    (Date.now()/1000 - latest.updatedAt.seconds)/3600
  );

  postMeta.innerText =
    `Updated ${hrs} hrs ago • Views ${latest.views||0}`;
}
loadLatestPost();

/* ✅ SINGLE SOURCE TOGGLE (BULLETPROOF) */
toggleBtn.onclick = async (e) => {
  e.stopPropagation();
  if (!currentPost || isToggling) return;

  isToggling = true;
  expanded = !expanded;

  postCard.classList.toggle("expanded", expanded);
  toggleBtn.innerText = expanded ? "Collapse" : "Expand";

  if (expanded && !viewCounted){
    await updateDoc(doc(db,"posts", currentPost.id),{
      views: increment(1)
    });
    viewCounted = true;
  }

  setTimeout(() => {
    isToggling = false;
  }, 650);
};

/* ================= ZENO ================= */
const eye = document.getElementById("zeno-eye");
const cloud = document.getElementById("zeno-cloud");
let zenoState = 0;

eye.onclick = () => {
  zenoState === 0 ? openProtocol() : closeZeno();
};

function openProtocol(){
  zenoState = 1;
  cloud.style.display = "block";
  cloud.innerHTML = `
    <p><strong>ZENO v1.0 — Test Protocol Model</strong></p>
    <p>
      Diagnostic mode active.<br><br>
      • Structure check<br>
      • Module scan<br>
      • Interaction monitor
    </p>
    <button onclick="zenoContinue()">Continue</button>
    <button onclick="closeZeno()">Close</button>
  `;
}

window.zenoContinue = () => {
  zenoState = 2;
  cloud.innerHTML = `
    <p><strong>Index Page Status</strong></p>
    <ul>
      <li>Header: stable</li>
      <li>Hall of Fame: stable</li>
      <li>Expand logic: fixed</li>
      <li>Firebase: live</li>
    </ul>
    <button onclick="closeZeno()">Close</button>
  `;
};

window.closeZeno = () => {
  zenoState = 0;
  cloud.style.display = "none";
  cloud.innerHTML = "";
};
</script>

<!-- ================= ZENO HEARTBEAT ================= -->
<script>
(() => {
  const eye = document.getElementById("zeno-eye");
  if (!eye) return;
  let t = false;
  setInterval(() => {
    t = !t;
    eye.style.transform = t
      ? "translateZ(0) scale(1.0001)"
      : "translateZ(0) scale(1)";
  }, 900);
})();
</script>

</body>
</html>
